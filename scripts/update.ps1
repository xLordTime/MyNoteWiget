# ============================================# TaskBar Widget - Auto-Update Script# ============================================# Prueft auf neue Version und installiert automatisch# Verwendung: .\update.ps1 [-Force]param(    [switch]$Force = $false)$ErrorActionPreference = "Stop"# ============================================# KONFIGURATION# ============================================$RepoOwner = "xLordTime"$RepoName = "MyNoteWiget"$InstallPath = "$env:LOCALAPPDATA\TaskBarWidget"$ExeName = "TaskBarWidget.exe"$VersionFile = "$InstallPath\version.txt"# ============================================# FUNKTIONEN# ============================================function Write-ColorOutput($ForegroundColor) {    $fc = $host.UI.RawUI.ForegroundColor    $host.UI.RawUI.ForegroundColor = $ForegroundColor    if ($args) {        Write-Output $args    }    $host.UI.RawUI.ForegroundColor = $fc}function Get-InstalledVersion {    if (Test-Path $VersionFile) {        return Get-Content $VersionFile -Raw    }    return $null}function Get-LatestGitHubVersion {    try {        $url = "https://api.github.com/repos/$RepoOwner/$RepoName/commits/main"        $response = Invoke-RestMethod -Uri $url -Method Get -Headers @{            "User-Agent" = "TaskBarWidget-Updater"        }        return $response.sha.Substring(0, 7)    }    catch {        Write-ColorOutput Red "Fehler beim Abrufen der GitHub-Version: $_"        return $null    }}function Stop-TaskBarWidget {    $process = Get-Process -Name "TaskBarWidget" -ErrorAction SilentlyContinue    if ($process) {        Write-ColorOutput Yellow "Stoppe laufende TaskBarWidget Instanz..."        Stop-Process -Name "TaskBarWidget" -Force -ErrorAction SilentlyContinue        Start-Sleep -Seconds 2        return $true    }    return $false}function Update-Application {    Write-ColorOutput Cyan "Lade neueste Version herunter..."        $tempDir = "$env:TEMP\TaskBarWidget_Update_$(Get-Date -Format 'yyyyMMddHHmmss')"    New-Item -ItemType Directory -Path $tempDir -Force | Out-Null        try {        $zipUrl = "https://github.com/$RepoOwner/$RepoName/archive/refs/heads/main.zip"        $zipPath = "$tempDir\repo.zip"                Write-ColorOutput White "  -> Download von GitHub..."        Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -UseBasicParsing                Write-ColorOutput White "  -> Entpacke Dateien..."        Expand-Archive -Path $zipPath -DestinationPath $tempDir -Force                $extractedFolder = "$tempDir\$RepoName-main"                Write-ColorOutput White "  -> Erstelle Build..."        Push-Location $extractedFolder                $dotnetVersion = & dotnet --version 2>$null        if (-not $dotnetVersion) {            Write-ColorOutput Red ".NET SDK nicht gefunden!"            Write-ColorOutput Yellow "Bitte installiere .NET 8.0 SDK von: https://dotnet.microsoft.com/download"            Pop-Location            return $false        }                $publishOutput = & dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o "$tempDir\publish" 2>&1                if ($LASTEXITCODE -ne 0) {            Write-ColorOutput Red "Build fehlgeschlagen!"            Write-ColorOutput White $publishOutput            Pop-Location            return $false        }                Pop-Location                $wasRunning = Stop-TaskBarWidget                if (Test-Path $InstallPath) {            Write-ColorOutput White "  -> Sichere alte Version..."            $backupPath = "$InstallPath.backup_$(Get-Date -Format 'yyyyMMddHHmmss')"            Copy-Item -Path $InstallPath -Destination $backupPath -Recurse -Force        }                Write-ColorOutput White "  -> Installiere neue Version..."                if (-not (Test-Path $InstallPath)) {            New-Item -ItemType Directory -Path $InstallPath -Force | Out-Null        }                Copy-Item -Path "$tempDir\publish\$ExeName" -Destination "$InstallPath\$ExeName" -Force                $latestVersion = Get-LatestGitHubVersion        Set-Content -Path $VersionFile -Value $latestVersion -NoNewline                Write-ColorOutput Green "Update erfolgreich installiert!"        Write-ColorOutput White "   Version: $latestVersion"                if ($wasRunning) {            Write-ColorOutput Cyan "Starte TaskBarWidget..."            Start-Process "$InstallPath\$ExeName"        }                return $true    }    catch {        Write-ColorOutput Red "Update fehlgeschlagen: $_"        return $false    }    finally {        if (Test-Path $tempDir) {            Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue        }    }}# ============================================# HAUPTPROGRAMM# ============================================Write-ColorOutput Cyan "========================================"Write-ColorOutput Cyan "  TaskBar Widget - Auto-Updater"Write-ColorOutput Cyan "========================================"Write-Output ""if (-not (Test-Path "$InstallPath\$ExeName")) {    Write-ColorOutput Red "TaskBarWidget ist nicht installiert!"    Write-ColorOutput Yellow "Fuehre zuerst install.ps1 aus."    exit 1}$currentVersion = Get-InstalledVersionif ($currentVersion) {    Write-ColorOutput White "Installierte Version: $currentVersion"} else {    Write-ColorOutput Yellow "Keine Versionsinformation gefunden (alte Installation)"    $currentVersion = "unknown"}Write-ColorOutput White "Pruefe auf Updates..."$latestVersion = Get-LatestGitHubVersionif (-not $latestVersion) {    Write-ColorOutput Red "Konnte neueste Version nicht abrufen."    exit 1}Write-ColorOutput White "Neueste Version: $latestVersion"Write-Output ""if ($currentVersion -eq $latestVersion -and -not $Force) {    Write-ColorOutput Green "Du hast bereits die neueste Version!"    Write-Output ""    Write-ColorOutput White "Verwende -Force um trotzdem neu zu installieren:"    Write-ColorOutput Gray "  .\update.ps1 -Force"    exit 0}if ($Force) {    Write-ColorOutput Yellow "Force-Update wird durchgefuehrt..."} else {    Write-ColorOutput Cyan "Neue Version verfuegbar!"}Write-Output ""$confirmation = Read-Host "Update jetzt installieren? (J/N)"if ($confirmation -match "^[JjYy]") {    Write-Output ""    $success = Update-Application        if ($success) {        Write-Output ""        Write-ColorOutput Green "========================================"        Write-ColorOutput Green "  Update erfolgreich abgeschlossen!"        Write-ColorOutput Green "========================================"        Write-Output ""        Write-ColorOutput White "Verwende Rechts-Shift + Rechts-Strg um das Widget zu oeffnen."    } else {        Write-Output ""        Write-ColorOutput Red "========================================"        Write-ColorOutput Red "      Update fehlgeschlagen!"        Write-ColorOutput Red "========================================"        exit 1    }} else {    Write-ColorOutput Yellow "Update abgebrochen."    exit 0}